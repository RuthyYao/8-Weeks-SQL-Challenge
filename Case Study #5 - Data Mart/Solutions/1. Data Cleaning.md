# Case Study #5 - Data Mart
## 1. Data Cleaning

I performed the following steps that created a new table in the Data Mart schema named `clean_weekly_sale`.

* Convert the `week_date` to a DATE format

* Add a `week_number` as the second column for each `week_date` value, for example any value from the 1st of January to 7th of January will be 1, 8th to 14th will be 2 etc

* Add a `month_number` with the calendar month for each `week_date` value as the 3rd column

* Add a `calendar_year` column as the 4th column containing either 2018, 2019 or 2020 values

* Add a new column called `age_band` after the original `segment` column using the following mapping on the number inside the `segment` value
  

| segment | age_band     |
|---------|--------------|
| 1       | Young Adults |
| 2       | Middle Aged  |
| 3 or 4  | Retirees     |

* Add a new `demographic` column using the following mapping for the first letter in the `segment` values:

| segment | demographic |
|---------|-------------|
| C       | Couples     |
| F       | Families    |

* Fill all null string values with an "unknown" string value in the original `segment` column as well as the new `age_band` and `demographic` columns
  
* Generate a new `avg_transaction` column as the `sales value` divided by `transactions` rounded to 2 decimal places for each record

``` SQL
CREATE TABLE clean_weekly_sales
  WITH date_cte AS(
     SELECT 
        *,
        STR_TO_DATE(week_date, '%d/%m/%Y') AS formatted_date
     FROM weekly_sales) 
      
SELECT 
	formatted_date AS week_date,
	WEEK(formatted_date) AS week_number,
	MONTH(formatted_date) AS month_number,
	YEAR(formatted_date) AS calendar_year,
	segment,
	CASE
		WHEN RIGHT(segment, 1) = '1' THEN 'Young Adults'
		WHEN RIGHT(segment, 1) = '2' THEN 'Middle Aged'
		WHEN RIGHT(segment, 1) in ('3', '4') THEN 'Retirees'
		ELSE 'unknown'
		END AS age_band,
	CASE
		WHEN LEFT(segment, 1) = 'C' THEN 'Couples'
		WHEN LEFT(segment, 1) = 'F' THEN 'Families'
		ELSE 'unknown'
		END AS demographic,
	region,
	platform,
	customer_type,
	sales,
	transactions,
	ROUND(sales/transactions, 2) AS avg_transaction
FROM date_cte
;

SELECT * FROM clean_weekly_sales LIMIT 10
```
Running the above query will generate below table.

| **week_date** | **week_number** | **month_number** | **calendar_year** | **segment** | **age_band** | **demographic** | **region** | **platform** | **customer_type** | **sales** | **transactions** | **avg_transaction** |
|---------------|-----------------|------------------|-------------------|-------------|--------------|-----------------|------------|--------------|-------------------|-----------|------------------|---------------------|
| 2020-08-31    | 35              | 8                | 2020              | C3          | Retirees     | Couples         | ASIA       | Retail       | New               | 3656163   | 120631           | 30.31               |
| 2020-08-31    | 35              | 8                | 2020              | F1          | Young Adults | Families        | ASIA       | Retail       | New               | 996575    | 31574            | 31.56               |
| 2020-08-31    | 35              | 8                | 2020              | null        | unknown      | unknown         | USA        | Retail       | Guest             | 16509610  | 529151           | 31.20               |
| 2020-08-31    | 35              | 8                | 2020              | C1          | Young Adults | Couples         | EUROPE     | Retail       | New               | 141942    | 4517             | 31.42               |
| 2020-08-31    | 35              | 8                | 2020              | C2          | Middle Aged  | Couples         | AFRICA     | Retail       | New               | 1758388   | 58046            | 30.29               |
| 2020-08-31    | 35              | 8                | 2020              | F2          | Middle Aged  | Families        | CANADA     | Shopify      | Existing          | 243878    | 1336             | 182.54              |
| 2020-08-31    | 35              | 8                | 2020              | F3          | Retirees     | Families        | AFRICA     | Shopify      | Existing          | 519502    | 2514             | 206.64              |
| 2020-08-31    | 35              | 8                | 2020              | F1          | Young Adults | Families        | ASIA       | Shopify      | Existing          | 371417    | 2158             | 172.11              |
| 2020-08-31    | 35              | 8                | 2020              | F2          | Middle Aged  | Families        | AFRICA     | Shopify      | New               | 49557     | 318              | 155.84              |
| 2020-08-31    | 35              | 8                | 2020              | C3          | Retirees     | Couples         | AFRICA     | Retail       | New               | 3888162   | 111032           | 35.02               |
